/*
 * VPDB - Virtual Pinball Database
 * Copyright (C) 2019 freezy <freezy@vpdb.io>
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */

import { ThreeHelper } from '../three.helper';
import { Table } from '../../lib';
import { GLTF } from 'three/examples/jsm/loaders/GLTFLoader';
import { NodeBinaryReader } from '../../lib/io/binary-reader.node';

const three = new ThreeHelper();

describe('The VPinball surface generator', () => {

	let gltf: GLTF;

	before(async () => {
		const vpt = await Table.load(new NodeBinaryReader(three.fixturePath('table-surface.vpx')));
		gltf = await three.loadGlb(await vpt.exportGlb());
	});

	it('should generate a surface mesh', async () => {
		const vertices = three.concatMeshes(gltf, 'surfaces','Wall',['surfacetop-Wall', 'surfaceside-Wall']);
		let expectedVertices = [
			[251.000000, 353.000000, -0.000000],
			[251.000000, 353.000000, -50.000000],
			[252.024673, 365.885376, -50.000000],
			[252.024673, 365.885376, -0.000000],
			[252.024673, 365.885376, -0.000000],
			[252.024673, 365.885376, -50.000000],
			[252.357742, 382.222137, -50.000000],
			[252.357742, 382.222137, -0.000000],
			[252.357742, 382.222137, -0.000000],
			[252.357742, 382.222137, -50.000000],
			[252.200287, 401.531067, -50.000000],
			[252.200287, 401.531067, -0.000000],
			[252.200287, 401.531067, -0.000000],
			[252.200287, 401.531067, -50.000000],
			[251.753357, 423.333008, -50.000000],
			[251.753357, 423.333008, -0.000000],
			[251.753357, 423.333008, -0.000000],
			[251.753357, 423.333008, -50.000000],
			[251.218018, 447.148865, -50.000000],
			[251.218018, 447.148865, -0.000000],
			[251.218018, 447.148865, -0.000000],
			[251.218018, 447.148865, -50.000000],
			[250.795349, 472.499390, -50.000000],
			[250.795349, 472.499390, -0.000000],
			[250.795349, 472.499390, -0.000000],
			[250.795349, 472.499390, -50.000000],
			[250.686417, 498.905518, -50.000000],
			[250.686417, 498.905518, -0.000000],
			[250.686417, 498.905518, -0.000000],
			[250.686417, 498.905518, -50.000000],
			[250.812439, 512.354675, -50.000000],
			[250.812439, 512.354675, -0.000000],
			[250.812439, 512.354675, -0.000000],
			[250.812439, 512.354675, -50.000000],
			[251.092285, 525.888062, -50.000000],
			[251.092285, 525.888062, -0.000000],
			[251.092285, 525.888062, -0.000000],
			[251.092285, 525.888062, -50.000000],
			[251.551102, 539.445679, -50.000000],
			[251.551102, 539.445679, -0.000000],
			[251.551102, 539.445679, -0.000000],
			[251.551102, 539.445679, -50.000000],
			[252.214005, 552.967773, -50.000000],
			[252.214005, 552.967773, -0.000000],
			[252.214005, 552.967773, -0.000000],
			[252.214005, 552.967773, -50.000000],
			[253.106155, 566.394409, -50.000000],
			[253.106155, 566.394409, -0.000000],
			[253.106155, 566.394409, -0.000000],
			[253.106155, 566.394409, -50.000000],
			[254.252670, 579.665649, -50.000000],
			[254.252670, 579.665649, -0.000000],
			[254.252670, 579.665649, -0.000000],
			[254.252670, 579.665649, -50.000000],
			[255.678680, 592.721680, -50.000000],
			[255.678680, 592.721680, -0.000000],
			[255.678680, 592.721680, -0.000000],
			[255.678680, 592.721680, -50.000000],
			[257.409332, 605.502441, -50.000000],
			[257.409332, 605.502441, -0.000000],
			[257.409332, 605.502441, -0.000000],
			[257.409332, 605.502441, -50.000000],
			[259.469757, 617.948242, -50.000000],
			[259.469757, 617.948242, -0.000000],
			[259.469757, 617.948242, -0.000000],
			[259.469757, 617.948242, -50.000000],
			[261.885071, 629.999023, -50.000000],
			[261.885071, 629.999023, -0.000000],
			[261.885071, 629.999023, -0.000000],
			[261.885071, 629.999023, -50.000000],
			[264.680420, 641.594971, -50.000000],
			[264.680420, 641.594971, -0.000000],
			[264.680420, 641.594971, -0.000000],
			[264.680420, 641.594971, -50.000000],
			[267.880920, 652.676208, -50.000000],
			[267.880920, 652.676208, -0.000000],
			[267.880920, 652.676208, -0.000000],
			[267.880920, 652.676208, -50.000000],
			[271.511749, 663.182861, -50.000000],
			[271.511749, 663.182861, -0.000000],
			[271.511749, 663.182861, -0.000000],
			[271.511749, 663.182861, -50.000000],
			[275.597992, 673.054932, -50.000000],
			[275.597992, 673.054932, -0.000000],
			[275.597992, 673.054932, -0.000000],
			[275.597992, 673.054932, -50.000000],
			[280.164795, 682.232544, -50.000000],
			[280.164795, 682.232544, -0.000000],
			[280.164795, 682.232544, -0.000000],
			[280.164795, 682.232544, -50.000000],
			[285.237335, 690.655884, -50.000000],
			[285.237335, 690.655884, -0.000000],
			[285.237335, 690.655884, -0.000000],
			[285.237335, 690.655884, -50.000000],
			[290.840698, 698.265015, -50.000000],
			[290.840698, 698.265015, -0.000000],
			[290.840698, 698.265015, -0.000000],
			[290.840698, 698.265015, -50.000000],
			[297.000000, 705.000000, -50.000000],
			[297.000000, 705.000000, -0.000000],
			[297.000000, 705.000000, -0.000000],
			[297.000000, 705.000000, -50.000000],
			[304.438354, 711.402832, -50.000000],
			[304.438354, 711.402832, -0.000000],
			[304.438354, 711.402832, -0.000000],
			[304.438354, 711.402832, -50.000000],
			[312.916992, 717.199097, -50.000000],
			[312.916992, 717.199097, -0.000000],
			[312.916992, 717.199097, -0.000000],
			[312.916992, 717.199097, -50.000000],
			[322.365295, 722.416687, -50.000000],
			[322.365295, 722.416687, -0.000000],
			[322.365295, 722.416687, -0.000000],
			[322.365295, 722.416687, -50.000000],
			[332.712738, 727.083313, -50.000000],
			[332.712738, 727.083313, -0.000000],
			[332.712738, 727.083313, -0.000000],
			[332.712738, 727.083313, -50.000000],
			[343.888733, 731.226929, -50.000000],
			[343.888733, 731.226929, -0.000000],
			[343.888733, 731.226929, -0.000000],
			[343.888733, 731.226929, -50.000000],
			[355.822754, 734.875183, -50.000000],
			[355.822754, 734.875183, -0.000000],
			[355.822754, 734.875183, -0.000000],
			[355.822754, 734.875183, -50.000000],
			[368.444183, 738.056030, -50.000000],
			[368.444183, 738.056030, -0.000000],
			[368.444183, 738.056030, -0.000000],
			[368.444183, 738.056030, -50.000000],
			[381.682495, 740.797180, -50.000000],
			[381.682495, 740.797180, -0.000000],
			[381.682495, 740.797180, -0.000000],
			[381.682495, 740.797180, -50.000000],
			[395.467102, 743.126526, -50.000000],
			[395.467102, 743.126526, -0.000000],
			[395.467102, 743.126526, -0.000000],
			[395.467102, 743.126526, -50.000000],
			[409.727478, 745.071838, -50.000000],
			[409.727478, 745.071838, -0.000000],
			[409.727478, 745.071838, -0.000000],
			[409.727478, 745.071838, -50.000000],
			[424.393066, 746.660889, -50.000000],
			[424.393066, 746.660889, -0.000000],
			[424.393066, 746.660889, -0.000000],
			[424.393066, 746.660889, -50.000000],
			[439.393219, 747.921570, -50.000000],
			[439.393219, 747.921570, -0.000000],
			[439.393219, 747.921570, -0.000000],
			[439.393219, 747.921570, -50.000000],
			[454.657471, 748.881653, -50.000000],
			[454.657471, 748.881653, -0.000000],
			[454.657471, 748.881653, -0.000000],
			[454.657471, 748.881653, -50.000000],
			[470.115173, 749.568909, -50.000000],
			[470.115173, 749.568909, -0.000000],
			[470.115173, 749.568909, -0.000000],
			[470.115173, 749.568909, -50.000000],
			[485.695862, 750.011230, -50.000000],
			[485.695862, 750.011230, -0.000000],
			[485.695862, 750.011230, -0.000000],
			[485.695862, 750.011230, -50.000000],
			[501.328888, 750.236389, -50.000000],
			[501.328888, 750.236389, -0.000000],
			[501.328888, 750.236389, -0.000000],
			[501.328888, 750.236389, -50.000000],
			[516.943726, 750.272217, -50.000000],
			[516.943726, 750.272217, -0.000000],
			[516.943726, 750.272217, -0.000000],
			[516.943726, 750.272217, -50.000000],
			[532.469788, 750.146484, -50.000000],
			[532.469788, 750.146484, -0.000000],
			[532.469788, 750.146484, -0.000000],
			[532.469788, 750.146484, -50.000000],
			[562.973450, 749.521667, -50.000000],
			[562.973450, 749.521667, -0.000000],
			[562.973450, 749.521667, -0.000000],
			[562.973450, 749.521667, -50.000000],
			[592.275269, 748.584473, -50.000000],
			[592.275269, 748.584473, -0.000000],
			[592.275269, 748.584473, -0.000000],
			[592.275269, 748.584473, -50.000000],
			[619.810852, 747.557373, -50.000000],
			[619.810852, 747.557373, -0.000000],
			[619.810852, 747.557373, -0.000000],
			[619.810852, 747.557373, -50.000000],
			[645.015625, 746.662903, -50.000000],
			[645.015625, 746.662903, -0.000000],
			[645.015625, 746.662903, -0.000000],
			[645.015625, 746.662903, -50.000000],
			[667.325073, 746.123535, -50.000000],
			[667.325073, 746.123535, -0.000000],
			[667.325073, 746.123535, -0.000000],
			[667.325073, 746.123535, -50.000000],
			[686.174683, 746.161682, -50.000000],
			[686.174683, 746.161682, -0.000000],
			[686.174683, 746.161682, -0.000000],
			[686.174683, 746.161682, -50.000000],
			[694.125671, 746.466919, -50.000000],
			[694.125671, 746.466919, -0.000000],
			[694.125671, 746.466919, -0.000000],
			[694.125671, 746.466919, -50.000000],
			[701.000000, 747.000000, -50.000000],
			[701.000000, 747.000000, -0.000000],
			[701.000000, 747.000000, -0.000000],
			[701.000000, 747.000000, -50.000000],
			[745.000000, 249.000000, -50.000000],
			[745.000000, 249.000000, -0.000000],
			[745.000000, 249.000000, -0.000000],
			[745.000000, 249.000000, -50.000000],
			[251.000000, 353.000000, -50.000000],
			[251.000000, 353.000000, -0.000000],
			[251.000000, 353.000000, -50.000000],
			[252.024673, 365.885376, -50.000000],
			[252.357742, 382.222137, -50.000000],
			[252.200287, 401.531067, -50.000000],
			[251.753357, 423.333008, -50.000000],
			[251.218018, 447.148865, -50.000000],
			[250.795349, 472.499390, -50.000000],
			[250.686417, 498.905518, -50.000000],
			[250.812439, 512.354675, -50.000000],
			[251.092285, 525.888062, -50.000000],
			[251.551102, 539.445679, -50.000000],
			[252.214005, 552.967773, -50.000000],
			[253.106155, 566.394409, -50.000000],
			[254.252670, 579.665649, -50.000000],
			[255.678680, 592.721680, -50.000000],
			[257.409332, 605.502441, -50.000000],
			[259.469757, 617.948242, -50.000000],
			[261.885071, 629.999023, -50.000000],
			[264.680420, 641.594971, -50.000000],
			[267.880920, 652.676208, -50.000000],
			[271.511749, 663.182861, -50.000000],
			[275.597992, 673.054932, -50.000000],
			[280.164795, 682.232544, -50.000000],
			[285.237335, 690.655884, -50.000000],
			[290.840698, 698.265015, -50.000000],
			[297.000000, 705.000000, -50.000000],
			[304.438354, 711.402832, -50.000000],
			[312.916992, 717.199097, -50.000000],
			[322.365295, 722.416687, -50.000000],
			[332.712738, 727.083313, -50.000000],
			[343.888733, 731.226929, -50.000000],
			[355.822754, 734.875183, -50.000000],
			[368.444183, 738.056030, -50.000000],
			[381.682495, 740.797180, -50.000000],
			[395.467102, 743.126526, -50.000000],
			[409.727478, 745.071838, -50.000000],
			[424.393066, 746.660889, -50.000000],
			[439.393219, 747.921570, -50.000000],
			[454.657471, 748.881653, -50.000000],
			[470.115173, 749.568909, -50.000000],
			[485.695862, 750.011230, -50.000000],
			[501.328888, 750.236389, -50.000000],
			[516.943726, 750.272217, -50.000000],
			[532.469788, 750.146484, -50.000000],
			[562.973450, 749.521667, -50.000000],
			[592.275269, 748.584473, -50.000000],
			[619.810852, 747.557373, -50.000000],
			[645.015625, 746.662903, -50.000000],
			[667.325073, 746.123535, -50.000000],
			[686.174683, 746.161682, -50.000000],
			[694.125671, 746.466919, -50.000000],
			[701.000000, 747.000000, -50.000000],
			[745.000000, 249.000000, -50.000000],
		];
		three.expectVerticesInArray(expectedVertices, vertices);
	});

	it('should generate a surface mesh with invisible top', async () => {
		const vertices = three.concatMeshes(gltf, 'surfaces','TopInvisible', ['surfaceside-TopInvisible']);
		let expectedVertices = [
			[379.000000, 1125.000000, -2.700000],
			[379.000000, 1125.000000, -49.599998],
			[210.126160, 1250.418091, -49.599998],
			[210.126160, 1250.418091, -2.700000],
			[210.126160, 1250.418091, -2.700000],
			[210.126160, 1250.418091, -49.599998],
			[423.000000, 1249.000000, -49.599998],
			[423.000000, 1249.000000, -2.700000],
			[423.000000, 1249.000000, -2.700000],
			[423.000000, 1249.000000, -49.599998],
			[503.000000, 1453.000000, -49.599998],
			[503.000000, 1453.000000, -2.700000],
			[503.000000, 1453.000000, -2.700000],
			[503.000000, 1453.000000, -49.599998],
			[579.401611, 1249.220581, -49.599998],
			[579.401611, 1249.220581, -2.700000],
			[579.401611, 1249.220581, -2.700000],
			[579.401611, 1249.220581, -49.599998],
			[799.055176, 1249.158447, -49.599998],
			[799.055176, 1249.158447, -2.700000],
			[799.055176, 1249.158447, -2.700000],
			[799.055176, 1249.158447, -49.599998],
			[622.938904, 1124.456299, -49.599998],
			[622.938904, 1124.456299, -2.700000],
			[622.938904, 1124.456299, -2.700000],
			[622.938904, 1124.456299, -49.599998],
			[700.465210, 905.046875, -49.599998],
			[700.465210, 905.046875, -2.700000],
			[700.465210, 905.046875, -2.700000],
			[700.465210, 905.046875, -49.599998],
			[505.995239, 1055.478394, -49.599998],
			[505.995239, 1055.478394, -2.700000],
			[505.995239, 1055.478394, -2.700000],
			[505.995239, 1055.478394, -49.599998],
			[299.000000, 903.000000, -49.599998],
			[299.000000, 903.000000, -2.700000],
			[299.000000, 903.000000, -2.700000],
			[299.000000, 903.000000, -49.599998],
			[379.000000, 1125.000000, -49.599998],
			[379.000000, 1125.000000, -2.700000],
		];
		three.expectVerticesInArray(expectedVertices, vertices);
		three.expectNoObject(gltf, 'surfaces', 'TopInvisible', 'surfacetop-TopInvisible');
	});

	it('should generate a surface mesh with invisible sides', async () => {
		const vertices = three.concatMeshes(gltf, 'surfaces','SideInvisible', ['surfacetop-SideInvisible']);
		let expectedVertices = [
			[455.000000, 1667.000000, -11.500000],
			[450.444305, 1670.719604, -11.500000],
			[445.294983, 1674.163086, -11.500000],
			[439.592773, 1677.342285, -11.500000],
			[433.378265, 1680.268799, -11.500000],
			[426.692108, 1682.954102, -11.500000],
			[419.575012, 1685.410156, -11.500000],
			[412.067535, 1687.648438, -11.500000],
			[404.210419, 1689.680542, -11.500000],
			[387.609711, 1693.173218, -11.500000],
			[370.098083, 1695.981445, -11.500000],
			[352.000793, 1698.198486, -11.500000],
			[333.642975, 1699.917480, -11.500000],
			[315.349854, 1701.231812, -11.500000],
			[297.446655, 1702.234863, -11.500000],
			[264.110870, 1703.679443, -11.500000],
			[236.237183, 1704.997559, -11.500000],
			[225.161652, 1705.842285, -11.500000],
			[216.427277, 1706.934814, -11.500000],
			[230.669525, 1709.958374, -11.500000],
			[250.111069, 1713.393799, -11.500000],
			[273.306427, 1717.426025, -11.500000],
			[298.810181, 1722.239502, -11.500000],
			[311.976013, 1724.996826, -11.500000],
			[325.176880, 1728.018921, -11.500000],
			[338.232117, 1731.328613, -11.500000],
			[350.961029, 1734.948975, -11.500000],
			[363.182953, 1738.903198, -11.500000],
			[374.717224, 1743.214355, -11.500000],
			[385.383118, 1747.905518, -11.500000],
			[395.000000, 1753.000000, -11.500000],
			[402.884155, 1758.372803, -11.500000],
			[410.378571, 1764.854614, -11.500000],
			[417.523895, 1772.245605, -11.500000],
			[424.360809, 1780.345947, -11.500000],
			[430.929901, 1788.956055, -11.500000],
			[437.271851, 1797.875977, -11.500000],
			[449.436890, 1815.846191, -11.500000],
			[455.341248, 1824.497070, -11.500000],
			[461.181000, 1832.658813, -11.500000],
			[466.996826, 1840.131470, -11.500000],
			[472.829376, 1846.715454, -11.500000],
			[478.719238, 1852.210938, -11.500000],
			[484.707123, 1856.418091, -11.500000],
			[490.833618, 1859.137207, -11.500000],
			[497.139404, 1860.168457, -11.500000],
			[503.252838, 1859.412354, -11.500000],
			[509.186188, 1857.039551, -11.500000],
			[514.981750, 1853.244385, -11.500000],
			[520.681763, 1848.221680, -11.500000],
			[526.328369, 1842.165649, -11.500000],
			[531.963928, 1835.271118, -11.500000],
			[543.370605, 1819.744263, -11.500000],
			[555.239685, 1803.197388, -11.500000],
			[561.453186, 1795.027832, -11.500000],
			[567.908997, 1787.186768, -11.500000],
			[574.649353, 1779.869019, -11.500000],
			[581.716492, 1773.268921, -11.500000],
			[589.152649, 1767.581055, -11.500000],
			[597.000000, 1763.000000, -11.500000],
			[607.244019, 1758.605103, -11.500000],
			[618.687988, 1754.796021, -11.500000],
			[631.129150, 1751.523438, -11.500000],
			[644.364868, 1748.737793, -11.500000],
			[658.192444, 1746.389771, -11.500000],
			[672.409180, 1744.430054, -11.500000],
			[686.812439, 1742.808960, -11.500000],
			[701.199463, 1741.477417, -11.500000],
			[715.367676, 1740.385620, -11.500000],
			[729.114380, 1739.484497, -11.500000],
			[754.532349, 1738.056030, -11.500000],
			[775.831970, 1736.796631, -11.500000],
			[784.430725, 1736.106812, -11.500000],
			[791.391846, 1735.310791, -11.500000],
			[782.776245, 1733.164063, -11.500000],
			[771.908447, 1730.961060, -11.500000],
			[744.642761, 1726.191772, -11.500000],
			[712.047974, 1720.614258, -11.500000],
			[694.518799, 1717.401001, -11.500000],
			[676.577271, 1713.839844, -11.500000],
			[658.530151, 1709.882324, -11.500000],
			[640.683960, 1705.479736, -11.500000],
			[623.345398, 1700.583740, -11.500000],
			[606.821167, 1695.145508, -11.500000],
			[598.960205, 1692.208008, -11.500000],
			[591.417847, 1689.116577, -11.500000],
			[584.232300, 1685.865479, -11.500000],
			[577.442078, 1682.448364, -11.500000],
			[571.085388, 1678.859375, -11.500000],
			[565.200562, 1675.092285, -11.500000],
			[559.826050, 1671.141113, -11.500000],
			[555.000000, 1667.000000, -11.500000],
			[547.852234, 1659.343628, -11.500000],
			[541.405518, 1650.531250, -11.500000],
			[535.610596, 1640.746582, -11.500000],
			[530.418396, 1630.173096, -11.500000],
			[525.779663, 1618.994385, -11.500000],
			[521.645264, 1607.394043, -11.500000],
			[517.966064, 1595.555786, -11.500000],
			[514.692810, 1583.663086, -11.500000],
			[511.776398, 1571.899536, -11.500000],
			[509.167633, 1560.448730, -11.500000],
			[504.676361, 1539.219971, -11.500000],
			[500.825623, 1521.445557, -11.500000],
			[499.017517, 1514.312622, -11.500000],
			[497.222046, 1508.594116, -11.500000],
			[495.997772, 1514.351318, -11.500000],
			[494.916473, 1521.589844, -11.500000],
			[492.898560, 1539.714600, -11.500000],
			[490.599854, 1561.375977, -11.500000],
			[489.167603, 1573.035400, -11.500000],
			[487.451965, 1584.981689, -11.500000],
			[485.381958, 1597.016113, -11.500000],
			[482.886475, 1608.939331, -11.500000],
			[479.894470, 1620.552612, -11.500000],
			[476.334930, 1631.656616, -11.500000],
			[472.136749, 1642.052368, -11.500000],
			[467.228912, 1651.541016, -11.500000],
			[461.540344, 1659.923218, -11.500000],
		];
		three.expectVerticesInArray(expectedVertices, vertices);
		three.expectNoObject(gltf, 'surfaces', 'SideInvisible', 'surfaceside-SideInvisible');
	});

	it('should not generate a surface mesh with invisible sides and top', async () => {
		three.expectNoObject(gltf, 'surfaces', 'Invisible');
	});

});
